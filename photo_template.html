<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
    <title>Форма генерации шаблона для публикации фотографий</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
<!--
body {
    margin:0.5em 0.5em 0.5em 0.5em;
    padding:0;
    background:#EFE;
}

#form {
    padding: 1em;
    margin: 1em;
}

#form-labels {
    background:#EEF;
    position:absolute;
    top:2em;
    left:2em;
    padding:0.5em 0.5em 0.5em 0.5em;
    text-align:right;
}

#form-inputs {
    background:#FEE;
    position:absolute;
    top:2em;
    left:13em;
    right:2em;
    padding:0.5em 0.5em 0.5em 0.5em;
}

label {
    line-height:1.2em;
}

input {
    line-height:1.2em;
}

#output {
    padding-top: 12em;
    margin: 1em;
}

#result {
}

-->        
</style>
</head>


<body onload="doLoadSettings()">

<script language="javascript" type="text/javascript">

function setCookie(name,value)
{
    document.cookie = name + '=' + escape(value);
}

function getCookie(name)
{
    var value = null;

    var cookies = document.cookie;
    if ( cookies.length > 0 ) {
        var idx = cookies.indexOf(name+'=');
        if ( idx != -1 ) {
            idx += name.length+1;
            var eidx = cookies.indexOf(';',idx);
            if ( eidx == -1 ) { eidx = cookies.length; }
            value = unescape(cookies.substring(idx,eidx));
        }
    }

    return value;
}

function setSelectValue(selector,value)
{
    for( var idx = 0; idx < selector.length; ++idx ) {
        if ( selector[idx].value == value ) {
            selector.selectedIndex = idx;
        }
    }
}

function doLoadSettings()
{
    var c_val;
    c_val = getCookie('border');
    if ( c_val !== null ) { document.getElementById('border').value = c_val; }
    c_val = getCookie('v_space');
    if ( c_val !== null ) { document.getElementById('v_space').value = c_val; }
    c_val = getCookie('h_space');
    if ( c_val !== null ) { document.getElementById('h_space').value = c_val; }
    c_val = getCookie('nl_tag');
    if ( c_val !== null ) { setSelectValue( document.getElementById('nl_tag'), c_val ); }
    c_val = getCookie('previews');
    if ( c_val !== null ) { setSelectValue( document.getElementById('previews'), c_val ); }
    c_val = getCookie('preview_border');
    if ( c_val !== null ) { document.getElementById('preview_border').value = c_val; }
    c_val = getCookie('alt_on');
    if ( c_val !== null ) { document.getElementById('alt_on').checked = c_val; }
    c_val = getCookie('alt_desc');
    if ( c_val !== null ) { document.getElementById('alt_desc').checked = c_val; }
}

function doSaveSettings()
{
    setCookie( 'border', document.getElementById('border').value );
    setCookie( 'v_space', document.getElementById('v_space').value );
    setCookie( 'h_space', document.getElementById('h_space').value );
    setCookie( 'nl_tag', document.getElementById('nl_tag').value );
    setCookie( 'previews', document.getElementById('previews').value );
    setCookie( 'preview_border', document.getElementById('preview_border').value );
    setCookie( 'alt_on', document.getElementById('alt_on').checked );
    setCookie( 'alt_desc', document.getElementById('alt_desc').checked );
}

function createDocumentFragmentByString(str) 
{
    var range = document.createRange();
    range.setStartAfter(document.body);
    return range.createContextualFragment(str);
}

function createHTMLDocumentByString(str) 
{
    var html = str.replace(/<!DOCTYPE.*?>/, '').replace(/<html.*?>/, '').replace(/<\/html>.*/, '');
    var XHTML_NS = 'http://www.w3.org/1999/xhtml';
    var doctype = document.implementation.createDocumentType('html', '-//W3C//DTD HTML 4.01//EN', 'http://www.w3.org/TR/html4/strict.dtd');
    var htmlDoc  = document.implementation.createDocument(XHTML_NS, 'html', doctype);
    var fragment = createDocumentFragmentByString(html);
    htmlDoc.documentElement.appendChild(htmlDoc.importNode(fragment, true));
    return htmlDoc;
}

function doMakeTemplateFromYandex(url,htmldoc,from_idx,to_idx,n_idx,border,nl_tag,previews,preview_border,alt_on,alt_desc)
{
    var preview = "";
    var result = "";

    var nodes = htmldoc.evaluate('//a[@class="photo"]',htmldoc,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
    if ( nodes === undefined ) {
        result = "<Empty page>";
    } else {
        result = "";
        //alert( nodes.snapshotLength + " image(s)" );
        var re_size=/max-width: (\d+)px; max-height: (\d+)px;/;
        var re_src=/(.*)_[XXSLM]{1,4}$/;
        if ( to_idx === undefined || to_idx === "" || to_idx > nodes.snapshotLength ) { to_idx = nodes.snapshotLength; }
        for(var idx=from_idx-1, img_idx=n_idx; idx < to_idx; ++idx, ++img_idx ) {
            var link = nodes.snapshotItem(idx);
            var img;
            if ( link ) {
                img = link.children[0];
            }
            if ( !link || !img ) {
                result = "<format parse error!>";
                return result;
            } else {
                var src = img.getAttribute('src');
                var alt = "";
                if ( alt_on ) { alt = ' alt="'+img.alt+'"'; }
                var link_url = link.href;
                if ( link_url[0] == '/' ) {
                    var re_dom_url=/^((?:http:\/\/)?(?:[\w\-]+\.)[\w\-]+\.[\w\-]+)\//i;
                    var re_dom_url_res = re_dom_url.exec( url );
                    var root_url = "";
                    if ( re_dom_url_res ) { root_url = re_dom_url_res[1]; }
                    link_url = root_url+link_url;
                }
                var size = re_size.exec( img.getAttribute('style') );
                throw new Error( src );
                var src_url = re_src.exec( src )[1];
                if ( (size[1] == 800 && size[2] == 600)||(size[1] == 600 && size[2] == 800) ) {
                    src_url += '_XL';
                } else {
                    src_url += '_orig';
                }
                if ( previews != "none" ) {
                    if ( previews != 'yes' ) {
                        preview += '<a href="';
                        if ( previews == 'linkimage' ) { preview += src_url; } else { preview += link_url; }
                        preview +='">';
                    }
                    preview += '<img src="'+src+'"'+alt+' width="'+img.getAttribute('width')+'" height="'+img.getAttribute('height')+'" border="'+preview_border+'">\n';
                    if ( previews != 'yes' ) {
                        preview += '</a>';
                    }
                    preview += '\n';
                }
                  //
                var desc = '';
                if ( alt_desc ) { desc = img.alt; }
                var next_img = img_idx+'. '+desc+nl_tag+'\n<img src="'+src_url+'"'+alt+' width="'+size[1]+'" height="'+size[2]+'" '+border+'>'+nl_tag+nl_tag+'\n\n';
                result += next_img;
            }
        }
    }
    if ( preview !== "" ) { preview += "\n\n"; }

    return preview+result;
}

function doMakeTemplateFromGallery1(req,htmldoc,from_idx,to_idx,n_idx,border,nl_tag,previews,preview_border,alt_on,alt_desc)
{
    var preview = "";
    var result = "";

    var nodes = htmldoc.evaluate('//div[@class="vafloat2"]/table/tbody/tr/td[@align="center"]/a',htmldoc,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
    if ( nodes === undefined ) {
        result = "<Empty page>";
    } else {
        //alert( nodes.snapshotLength + " image(s)" );
        if ( to_idx === undefined || to_idx === "" || to_idx > nodes.snapshotLength ) { to_idx = nodes.snapshotLength; }
        for(var idx=from_idx-1, img_idx=n_idx; idx < to_idx; ++idx, ++img_idx ) {
            var link = nodes.snapshotItem(idx);
            var img;
            if ( link ) {
                img = link.children[0];
            }
            if ( !link || !img ) {
                result = "<format parse error!>";
                return result;
            } else {
                var src = img.getAttribute('src');
                var alt = "";
                var link_url = link.href+'?full=1';
                  //
                req.open( 'GET', link_url, false );
                req.send( null );
                if ( req.status != 200 && req.status !== 0 ) {
                    result = "ошибка получения страницы " + link_url;
                } else {
                    var linkhtmldoc = createHTMLDocumentByString(req.responseText);
                    var full_img = linkhtmldoc.evaluate('//table/tbody/tr/td[@align="center"]/a/img',linkhtmldoc,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
                    if ( !full_img ) {
                        result = "ошибка получения адреса полного изображения из страницы " + link_url;
                        return result;
                    } else {
                        var full_src = full_img.src;
                        if ( alt_on ) { alt = ' alt="'+img.getAttribute('alt')+'"'; }
                        if ( previews != 'none' ) {
                            if ( previews != 'yes' ) {
                                preview += '<a href="';
                                if ( previews == 'linkimage' ) { preview += full_src; } else { preview += link.href; }
                                preview +='">';
                            }
                            preview += '<img src="'+src+'"'+alt+' width="'+img.getAttribute('width')+'" height="'+img.getAttribute('height')+'" border="'+preview_border+'">';
                            if ( previews != 'yes' ) {
                                preview += '</a>';
                            }
                            preview += '\n';
                        }
                          //
                        var desc = '';
                        if ( alt_on ) { alt = ' alt="'+full_img.alt+'"'; }
                        if ( alt_desc ) { desc = full_img.alt; }
                        var next_img = img_idx+'. '+desc+nl_tag+'\n<img src="'+full_src+'"'+alt+' width="'+full_img.width+'" height="'+full_img.height+'" '+border+'>'+nl_tag+nl_tag+'\n\n';
                        result += next_img;
                    }
                }
            }
        }
    }
    if ( preview !== "" ) { preview += "\n\n"; }

    return preview+result;
}

function doMakeTemplateFromGallery2(url,req,htmldoc,from_idx,to_idx,n_idx,border,nl_tag,previews,preview_border,alt_on,alt_desc)
{
    var preview = "";
    var result = "";

    var nodes = htmldoc.evaluate('//td[@class="giItemCell"]/div/a',htmldoc,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
    if ( nodes === undefined ) {
        result = "<Empty page>";
    } else {
        //alert( nodes.snapshotLength + " image(s)" );
        var re_dom_url=/^((?:http:\/\/)?(?:\w+\.)\w+\.\w+)\//i;
        var re_dom_url_res = re_dom_url.exec( url );
        var root_url = "";
        if ( re_dom_url_res ) { root_url = re_dom_url_res[1]; }
        if ( to_idx === undefined || to_idx === "" || to_idx > nodes.snapshotLength ) { to_idx = nodes.snapshotLength; }
        for(var idx=from_idx-1, img_idx=n_idx; idx < to_idx; ++idx, ++img_idx ) {
            var link = nodes.snapshotItem(idx);
            var img;
            if ( link ) {
                img = link.children[0];
            }
            if ( !link || !img ) {
                result = "<format parse error!>";
                return result;
            } else {
                var src = img.getAttribute('src');
                if ( src[0] == '/' ) { src = root_url+src; }
                var alt = "";
                var link_url = link.href;
                if ( link_url[0] == '/' ) { link_url = root_url+link_url; }
                  //
                req.open( 'GET', link_url, false );
                req.send( null );
                if ( req.status != 200 && req.status !== 0 ) {
                    result = "ошибка получения страницы " + link_url;
                } else {
                    var linkhtmldoc = createHTMLDocumentByString(req.responseText);
                    var full_img = linkhtmldoc.evaluate('//div[@id="photo"]/img',linkhtmldoc,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
                    if ( !full_img ) {
                        result = "ошибка получения адреса полного изображения из страницы " + link_url;
                        return result;
                    } else {
                        var full_src = full_img.src;
                        if ( full_src[0] == '/' ) { full_src = root_url + full_src; }
                        if ( alt_on ) { alt = ' alt="'+img.alt+'"'; }
                        if ( previews != "none" ) {
                            if ( previews != 'yes' ) {
                                preview += '<a href="';
                                if ( previews == 'linkimage' ) { preview += full_src; } else { preview += link_url; }
                                preview +='">';
                            }
                            preview += '<img src="'+src+'"'+alt+' width="'+img.width+'" height="'+img.height+'" border="'+preview_border+'">';
                            if ( previews != 'yes' ) {
                                preview += '</a>';
                            }
                            preview += '\n';
                        }
                        var desc = '';
                        if ( alt_on ) { alt = ' alt="'+full_img.alt+'"'; }
                        if ( alt_desc ) { desc = full_img.alt; }
                        var next_img = img_idx+'. '+desc+nl_tag+'\n<img src="'+full_src+'"'+alt+' width="'+full_img.width+'" height="'+full_img.height+'" '+border+'>'+nl_tag+nl_tag+'\n\n';
                        result += next_img;
                    }
                }
            }
        }
    }
    if ( preview !== "" ) { preview += "\n\n"; }

    return preview+result;
}

function setLabelText(id,text)
{
    var elem;

    if( document.getElementById  && (elem=document.getElementById(id)) )
    {
        if( !elem.firstChild ) {
           elem.appendChild( document.createTextNode( text ) );
        } else  {
            elem.firstChild.data = text;
        }

        return true;
    }

    return false;
}

function doMakeTemplate() 
{
    var result = "<Unknown error>";

    var type = document.getElementById('type_name').value;
    var url = document.getElementById('url').value;

    document.getElementById('result').value = "";
    setLabelText("status","обработка ...");
    var status = "";

    var from_idx = document.getElementById('from').value;
    if ( from_idx === undefined || from_idx === "" ) { from_idx = 1; }
    var to_idx = document.getElementById('to').value;
    var idx = document.getElementById('idx').value;
    if ( idx === undefined || idx === "" ) { idx = 1; }
    var border = document.getElementById('border').value;
    if ( border === undefined || border === "" ) { border = 0; }
    var v_space = document.getElementById('v_space').value;
    if ( v_space === undefined ) { v_space = ""; }
    var h_space = document.getElementById('h_space').value;
    if ( h_space === undefined ) { h_space = ""; }
    var nl_tag = document.getElementById('nl_tag').value;
    if ( nl_tag == 'none' ) { nl_tag = ''; } else { nl_tag = '<'+nl_tag+'/>'; }
    var previews = document.getElementById('previews').value;
    if ( previews === undefined || previews === "" ) { previews = "none"; }
    var preview_border = document.getElementById('preview_border').value;
    if ( preview_border === undefined || preview_border === "" ) { preview_border = 0; }
    var alt_on = document.getElementById('alt_on').checked;
    var alt_desc = document.getElementById('alt_desc').checked;
      //
    var border_str = 'border="'+border+'"';
    if ( v_space !== "" ) { border_str+=' vspace="'+v_space+'"'; }
    if ( h_space !== "" ) { border_str+=' hspace="'+h_space+'"'; }
      //
    if ( type == "ya.fotki" || "gallery1" || "gallery2" ) {
        var req;
        try {
            netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect UniversalBrowserAccess');
            req = new XMLHttpRequest();
        }
        catch (error) {
            alert("Error initializing XMLHttpRequest 1.\n" + error);
        }
        req.open( 'GET', url, false );
        req.send( null );
        if ( req.status != 200 && req.status !== 0 ) {
            status = "ошибка получения альбома " + req.status;
        } else {
            var text = req.responseText;
            text = text.replace(/(<[^>]*?)on(?:(?:un)?load|(?:db)?click|mouse(?:down|up|over|out|move)|key(?:press|down|up)|abort|blur|change|error|focus|re(?:size|set)|select|submit)\s*?=\s*?["'][^"']*?["']/ig, "$1");
            text = text.replace(/<\s*?script[^>]*?>[\s\S]*?<\s*?\/script\s*?>/ig, "");
            var htmldoc = createHTMLDocumentByString(text);
            if ( type == "ya.fotki" ) {
                result = doMakeTemplateFromYandex(url,htmldoc,from_idx,to_idx,idx,border_str,nl_tag,previews,preview_border,alt_on,alt_desc);
                status = "ok";
            } else if ( type == "gallery1" ) {
                result = doMakeTemplateFromGallery1(req,htmldoc,from_idx,to_idx,idx,border_str,nl_tag,previews,preview_border,alt_on,alt_desc);
                status = "ok";
            } else if ( type == "gallery2" ) {
                result = doMakeTemplateFromGallery2(url,req,htmldoc,from_idx,to_idx,idx,border_str,nl_tag,previews,preview_border,alt_on,alt_desc);
                status = "ok";
            } else {
                result = "Unknown gallery type:"+type;
                status = "gallery error";
            }
        }
    } else {
        result = "Unknown gallery type:"+type;
        status = "gallery error";
    }

    document.getElementById('result').value = result;
    doSaveSettings();
    setLabelText("status",status);
}

</script>

    <div id="form">
        <form action="">
            <div id="form-labels">
                <label for="url">Адрес галереи:&nbsp;</label><br/>
                <label for="type">Тип галереи:&nbsp;</label><br/>
            </div>
            <div id="form-inputs">
                <input type="text" id="url" value="" size="128" maxlength="255" /><br/>
                <input type="radio" name="type" id="type" value="ya.fotki" checked="checked" onClick="document.getElementById('type_name').value='ya.fotki';" /> Яндекс.Фотки
                <input type="radio" name="type" value="gallery1" onClick="document.getElementById('type_name').value='gallery1';" /> Gallery1 (menalto)
                <input type="radio" name="type" value="gallery2" onClick="document.getElementById('type_name').value='gallery2';" /> Gallery2 (menalto)
                <input type="hidden" id="type_name" value="ya.fotki" /><br/>
                <br/>
                <label for="from">С номера:&nbsp;</label><input type="text" id="from" value="1" size="2" maxlength="2" />
                <label for="to">По номер:&nbsp;</label><input type="text" id="to" value="" size="2" maxlength="2" />
                <label for="idx">Нумеровать c:&nbsp;</label><input type="text" id="idx" value="" size="2" maxlength="2" />
                <label for="alt_on">Добавить alt:&nbsp;</label><input type="checkbox" id="alt_on" />
                <label for="alt_desc">Добавить alt в описание:&nbsp;</label><input type="checkbox" id="alt_desc" />
                <br/><br/>
                <label for="border">Граница:&nbsp;</label><input type="text" id="border" value="1" size="1" maxlength="1" />
                <label for="v_space">VSpace:&nbsp;</label><input type="text" id="v_space" value="5" size="2" maxlength="2" />
                <label for="h_space">HSpace:&nbsp;</label><input type="text" id="h_space" value="" size="2" maxlength="2" />
                <label for"nl_tag">Таг новой строки:&nbsp;</label>
                <select id="nl_tag" />
                    <option value="none">Нет</option>
                    <option value="br">BR</option>
                    <option value="p">P</option>
                </select>
                <br/><br/>
                <label for="previews">Миниатюры:&nbsp;</label>
                <select id="previews">
                    <option value="none">Нет</option>
                    <option value="yes">Да</option>
                    <option value="linkimage">Со ссылкой на полную</option>
                    <option value="linkpage">Со ссылкой на страницу</option>
                </select>
                <label for="preview_border">Граница:&nbsp;</label><input type="text" id="preview_border" value="0" size="1" maxlength="1" /><br/>
                <br/>
                <input type="button" value="Обработать" onClick="doMakeTemplate(this.form);" />
            </div>
        </form>
    </div>

    <div id="output">
        <label for="status">Статус:&nbsp;&nbsp;</label><label id="status"></label><br/><br/>
        <label for="result">Результат:</label><br/>
        <textarea id="result" cols="100" rows="25" readonly="readonly"></textarea>
    </div>

</body>

</html>
